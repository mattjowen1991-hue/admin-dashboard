<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NFL Picks - Admin Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0a0a0f;
      --bg-card: #12121a;
      --bg-game: #1a1a24;
      --gold: #d4af37;
      --gold-dim: #8b7355;
      --green: #2ecc71;
      --red: #e74c3c;
      --orange: #f39c12;
      --text: #ffffff;
      --text-muted: #8a8a9a;
      --border: #2a2a3a;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Roboto Condensed', sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      background-image: 
        radial-gradient(ellipse at top, rgba(212, 175, 55, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at bottom, rgba(212, 175, 55, 0.03) 0%, transparent 50%);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header h1 {
      font-family: 'Oswald', sans-serif;
      font-size: 1.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--gold);
    }

    .header-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-family: 'Oswald', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--gold), #b8960b);
      color: var(--bg-dark);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
    }

    .btn-secondary {
      background: var(--bg-game);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--gold);
    }

    .btn-danger {
      background: var(--red);
      color: white;
    }

    /* Stats Bar */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-family: 'Oswald', sans-serif;
      font-size: 2rem;
      font-weight: 700;
      color: var(--gold);
    }

    .stat-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 4px;
    }

    /* Main Grid */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 24px;
    }

    @media (max-width: 1000px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Card */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .card-title {
      font-family: 'Oswald', sans-serif;
      font-size: 1.2rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text);
    }

    /* Picks Table */
    .picks-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .picks-table th,
    .picks-table td {
      padding: 12px 8px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .picks-table th {
      background: var(--bg-game);
      font-family: 'Oswald', sans-serif;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gold);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .picks-table tr:hover td {
      background: rgba(212, 175, 55, 0.05);
    }

    .picks-table .player-name {
      font-weight: 600;
      color: var(--text);
    }

    .picks-table .pick-cell {
      font-size: 0.8rem;
    }

    .picks-table .pick-cell.missing {
      color: var(--red);
      font-style: italic;
    }

    .picks-table .pick-cell.correct {
      color: var(--green);
      font-weight: 600;
    }

    .picks-table .pick-cell.incorrect {
      color: var(--red);
    }

    .table-scroll {
      overflow-x: auto;
      max-height: 500px;
      overflow-y: auto;
    }

    /* Submission Log */
    .submission-log {
      max-height: 300px;
      overflow-y: auto;
    }

    .submission-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }

    .submission-item:last-child {
      border-bottom: none;
    }

    .submission-player {
      font-weight: 600;
    }

    .submission-time {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .submission-badge {
      font-size: 0.7rem;
      padding: 4px 8px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .submission-badge.on-time {
      background: rgba(46, 204, 113, 0.2);
      color: var(--green);
    }

    .submission-badge.grace {
      background: rgba(243, 156, 18, 0.2);
      color: var(--orange);
    }

    /* Export Section */
    .export-section {
      margin-top: 20px;
    }

    .export-textarea {
      width: 100%;
      height: 200px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      color: var(--text);
      font-family: monospace;
      font-size: 0.85rem;
      resize: vertical;
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-badge.complete {
      background: rgba(46, 204, 113, 0.2);
      color: var(--green);
    }

    .status-badge.partial {
      background: rgba(243, 156, 18, 0.2);
      color: var(--orange);
    }

    .status-badge.missing {
      background: rgba(231, 76, 60, 0.2);
      color: var(--red);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .spinner {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid var(--border);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Admin PIN Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .modal h2 {
      font-family: 'Oswald', sans-serif;
      font-size: 1.5rem;
      color: var(--gold);
      margin-bottom: 24px;
    }

    .modal input {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 1.2rem;
      text-align: center;
      letter-spacing: 8px;
      margin-bottom: 20px;
    }

    .modal input:focus {
      outline: none;
      border-color: var(--gold);
    }

    .modal-error {
      color: var(--red);
      margin-bottom: 16px;
      display: none;
    }

    /* WhatsApp Format */
    .whatsapp-output {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 0.85rem;
      max-height: 300px;
      overflow-y: auto;
    }

    /* Config Editor */
    .config-section {
      margin-top: 20px;
    }

    .config-row {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }

    .config-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .config-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: inherit;
    }

    .config-input:focus {
      outline: none;
      border-color: var(--gold);
    }
  </style>
</head>
<body>
  <!-- Admin PIN Modal -->
  <div class="modal-overlay" id="adminModal">
    <div class="modal">
      <h2>üîê Admin Access</h2>
      <p style="color: var(--text-muted); margin-bottom: 20px;">Enter admin PIN to continue</p>
      <input type="password" id="adminPinInput" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric">
      <div class="modal-error" id="adminError">Incorrect PIN</div>
      <button class="btn btn-primary" id="adminLoginBtn" style="width: 100%;">Access Dashboard</button>
    </div>
  </div>

  <div class="container" id="mainContent" style="display: none;">
    <!-- Header -->
    <header class="header">
      <h1>üèà Admin Dashboard</h1>
      <div class="header-actions">
        <button class="btn btn-secondary" id="refreshBtn">‚Üª Refresh</button>
        <button class="btn btn-primary" id="exportValidatorBtn">Export for Validator</button>
        <button class="btn btn-secondary" id="copyWhatsAppBtn">Copy WhatsApp Format</button>
      </div>
    </header>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-value" id="statWeek">--</div>
        <div class="stat-label">Week</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statSubmitted">--</div>
        <div class="stat-label">Submitted</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statPending">--</div>
        <div class="stat-label">Pending</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statGames">--</div>
        <div class="stat-label">Games</div>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">
      <!-- Picks Table -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">All Picks</h2>
          <div id="tableStatus"></div>
        </div>
        <div class="table-scroll">
          <table class="picks-table" id="picksTable">
            <thead>
              <tr id="tableHeader"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Sidebar -->
      <div>
        <!-- Submission Log -->
        <div class="card">
          <h2 class="card-title">Submission Log</h2>
          <div class="submission-log" id="submissionLog">
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading...</p>
            </div>
          </div>
        </div>

        <!-- Export Section -->
        <div class="card">
          <h2 class="card-title">Export for Validator</h2>
          <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px;">
            Copy this and paste into "Bulk paste picks" in your validator
          </p>
          <textarea class="export-textarea" id="validatorExport" readonly placeholder="No picks yet..."></textarea>
          <button class="btn btn-secondary" style="margin-top: 12px; width: 100%;" id="copyExportBtn">Copy to Clipboard</button>
        </div>

        <!-- WhatsApp Output -->
        <div class="card">
          <h2 class="card-title">WhatsApp Summary</h2>
          <div class="whatsapp-output" id="whatsappOutput">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURATION - MUST MATCH player-picks.html
    // ============================================
    const CONFIG = {
      // JSONBin.io settings
      JSONBIN_BIN_ID: '69487a81ae596e708fa937cb',
      JSONBIN_API_KEY: '$2a$10$C7BY0Kl0u74gNn/kXO7xNuayWv493/f1jAxlHUmx3ENADQKDii61C',
      
      // Admin PIN (change this!)
      ADMIN_PIN: '292292',
      
      // Current week
      WEEK: 1,
      
      // All players
      PLAYERS: ['matt', 'jarv', 'gaz', 'joe', 'ben', 'coley', 'mark', 'ste', 'tony', 'jay', 'lee', 'liam'],
      
      // Games for this week (must match player-picks.html)
      GAMES: [
        { home: 'Kansas City Chiefs', away: 'Baltimore Ravens', doublePoints: false },
        { home: 'San Francisco 49ers', away: 'Dallas Cowboys', doublePoints: false },
        { home: 'Philadelphia Eagles', away: 'Green Bay Packers', doublePoints: false },
        { home: 'Detroit Lions', away: 'Minnesota Vikings', doublePoints: true },
        { home: 'Buffalo Bills', away: 'Miami Dolphins', doublePoints: false },
      ]
    };

    // ============================================
    // STATE
    // ============================================
    let picksData = null;

    // ============================================
    // ADMIN LOGIN
    // ============================================
    function checkAdminAccess() {
      const modal = document.getElementById('adminModal');
      const input = document.getElementById('adminPinInput');
      const error = document.getElementById('adminError');
      const btn = document.getElementById('adminLoginBtn');

      btn.addEventListener('click', () => {
        if (input.value === CONFIG.ADMIN_PIN) {
          modal.style.display = 'none';
          document.getElementById('mainContent').style.display = 'block';
          loadData();
        } else {
          error.style.display = 'block';
          input.value = '';
          input.focus();
        }
      });

      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') btn.click();
      });

      input.focus();
    }

    // ============================================
    // DATA LOADING
    // ============================================
    async function loadData() {
      try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}/latest`, {
          headers: {
            'X-Access-Key': CONFIG.JSONBIN_API_KEY
          }
        });

        if (response.ok) {
          const data = await response.json();
          picksData = data.record || { week: CONFIG.WEEK, picks: {}, submissions: [] };
        } else {
          picksData = { week: CONFIG.WEEK, picks: {}, submissions: [] };
        }

        renderDashboard();
      } catch (err) {
        console.error('Error loading data:', err);
        picksData = { week: CONFIG.WEEK, picks: {}, submissions: [] };
        renderDashboard();
      }
    }

    // ============================================
    // RENDER DASHBOARD
    // ============================================
    function renderDashboard() {
      updateStats();
      renderPicksTable();
      renderSubmissionLog();
      renderValidatorExport();
      renderWhatsAppOutput();
    }

    function updateStats() {
      const submitted = Object.keys(picksData.picks || {}).length;
      const pending = CONFIG.PLAYERS.length - submitted;

      document.getElementById('statWeek').textContent = CONFIG.WEEK;
      document.getElementById('statSubmitted').textContent = submitted;
      document.getElementById('statPending').textContent = pending;
      document.getElementById('statGames').textContent = CONFIG.GAMES.length;
    }

    function renderPicksTable() {
      const header = document.getElementById('tableHeader');
      const body = document.getElementById('tableBody');

      // Build header
      let headerHtml = '<th>Player</th>';
      CONFIG.GAMES.forEach((game, i) => {
        const shortHome = game.home.split(' ').pop();
        const shortAway = game.away.split(' ').pop();
        headerHtml += `<th title="${game.away} @ ${game.home}">${shortAway}<br>@<br>${shortHome}${game.doublePoints ? ' ‚≠ê' : ''}</th>`;
      });
      headerHtml += '<th>Status</th>';
      header.innerHTML = headerHtml;

      // Build body
      let bodyHtml = '';
      CONFIG.PLAYERS.forEach(player => {
        const playerPicks = picksData.picks?.[player] || {};
        const pickCount = Object.keys(playerPicks).length;
        
        bodyHtml += '<tr>';
        bodyHtml += `<td class="player-name">${capitalize(player)}</td>`;
        
        CONFIG.GAMES.forEach((game, i) => {
          const pick = playerPicks[i];
          if (pick) {
            const shortPick = pick.split(' ').pop();
            bodyHtml += `<td class="pick-cell" title="${pick}">${shortPick}</td>`;
          } else {
            bodyHtml += `<td class="pick-cell missing">‚Äî</td>`;
          }
        });

        // Status
        if (pickCount === CONFIG.GAMES.length) {
          bodyHtml += `<td><span class="status-badge complete">‚úì Complete</span></td>`;
        } else if (pickCount > 0) {
          bodyHtml += `<td><span class="status-badge partial">${pickCount}/${CONFIG.GAMES.length}</span></td>`;
        } else {
          bodyHtml += `<td><span class="status-badge missing">Not submitted</span></td>`;
        }
        
        bodyHtml += '</tr>';
      });

      body.innerHTML = bodyHtml;
    }

    function renderSubmissionLog() {
      const log = document.getElementById('submissionLog');
      const submissions = picksData.submissions || [];

      if (submissions.length === 0) {
        log.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No submissions yet</p>';
        return;
      }

      // Sort by timestamp descending (most recent first)
      const sorted = [...submissions].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      let html = '';
      sorted.forEach(sub => {
        const time = new Date(sub.timestamp);
        const timeStr = time.toLocaleString('en-GB', { 
          day: '2-digit', 
          month: 'short', 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        
        html += `
          <div class="submission-item">
            <div>
              <div class="submission-player">${capitalize(sub.player)}</div>
              <div class="submission-time">${timeStr}</div>
            </div>
            <span class="submission-badge ${sub.inGracePeriod ? 'grace' : 'on-time'}">
              ${sub.inGracePeriod ? 'Grace Period' : 'On Time'}
            </span>
          </div>
        `;
      });

      log.innerHTML = html;
    }

    function renderValidatorExport() {
      const textarea = document.getElementById('validatorExport');
      const picks = picksData.picks || {};

      let output = '';
      CONFIG.PLAYERS.forEach(player => {
        const playerPicks = picks[player] || {};
        if (Object.keys(playerPicks).length > 0) {
          output += `${player}:\n`;
          CONFIG.GAMES.forEach((game, i) => {
            const pick = playerPicks[i] || 'missed';
            output += `${pick}\n`;
          });
          output += '\n';
        }
      });

      textarea.value = output.trim() || 'No picks submitted yet...';
    }

    function renderWhatsAppOutput() {
      const output = document.getElementById('whatsappOutput');
      const picks = picksData.picks || {};

      let wa = `üèà WEEK ${CONFIG.WEEK} PICKS üèà\n`;

      CONFIG.GAMES.forEach((game, i) => {
        const homePickers = [];
        const awayPickers = [];

        CONFIG.PLAYERS.forEach(player => {
          const pick = picks[player]?.[i];
          if (pick === game.home) {
            homePickers.push(capitalize(player));
          } else if (pick === game.away) {
            awayPickers.push(capitalize(player));
          }
        });

        wa += `\n${game.away} @ ${game.home}\n`;
        wa += `‚Ä¢ ${game.home.split(' ').pop()} ‚Üí ${homePickers.join(', ') || 'None'}\n`;
        wa += `‚Ä¢ ${game.away.split(' ').pop()} ‚Üí ${awayPickers.join(', ') || 'None'}\n`;
        if (game.doublePoints) {
          wa += `(DOUBLE POINTS)\n`;
        }
      });

      output.textContent = wa.trim();
    }

    // ============================================
    // UTILITIES
    // ============================================
    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        // Brief visual feedback could be added here
      });
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    document.getElementById('refreshBtn').addEventListener('click', loadData);

    document.getElementById('copyExportBtn').addEventListener('click', () => {
      const text = document.getElementById('validatorExport').value;
      copyToClipboard(text);
      alert('Copied to clipboard!');
    });

    document.getElementById('exportValidatorBtn').addEventListener('click', () => {
      const text = document.getElementById('validatorExport').value;
      copyToClipboard(text);
      alert('Validator format copied to clipboard!');
    });

    document.getElementById('copyWhatsAppBtn').addEventListener('click', () => {
      const text = document.getElementById('whatsappOutput').textContent;
      copyToClipboard(text);
      alert('WhatsApp format copied to clipboard!');
    });

    // ============================================
    // INIT
    // ============================================
    checkAdminAccess();
  </script>
</body>
</html>
